#!/bin/bash
#
# videomessageify.sh - Automates video processing and publishing.
#
# This script uploads a video, transcribes it, generates an AI title,
# renames the files, and copies them to a Google Drive remote via rclone.
#
# Usage:
#   ./videomessageify.sh /path/to/my/video.mp4
#
# Dependencies:
#   - On the server: ffmpeg, whisper, rclone (configured for GDrive)
#   - On this machine: jq
#   - An environment variable $OPENROUTER_API_KEY must be set.
#

# Exit immediately if a command exits with a non-zero status.
set -e

# --- CONFIGURATION ---
server="yeshu@${STORMFATHER_IP:-192.168.20.23}"
remote_dir="videomessages"
gdrive_remote="waha.app_gd"
gdrive_dir="Video Messages"
ai_model="qwen/qwen3-235b-a22b-07-25:nitro"

# --- PRE-FLIGHT CHECKS ---
if ! command -v jq &> /dev/null;
then
  echo "‚ùå Error: jq is not installed. Please install it to proceed."
  exit 1
fi
if [ -z "$OPENROUTER_API_KEY" ];
then
  echo "‚ùå Error: OPENROUTER_API_KEY environment variable is not set."
  exit 1
fi
# --- SCRIPT ---

# Determine the file to process
if [ -z "$1" ]; then
  # No file provided, find the most recent one
  latest_file=$(ls -tp | grep -v /$ | head -n 1)
  if [ -z "$latest_file" ]; then
    echo "‚ùå Error: No files found in the current directory."
    exit 1
  fi
  
  read -p "No file specified. Do you want to run videomessageify on the most recent file, '$latest_file'? (Y/n) " -r response
  if [[ "$response" =~ ^[Yy]$ ]] || [ -z "$response" ]; then
    local_file_path="$latest_file"
  else
    echo "Cancelled."
    exit 0
  fi
else
  local_file_path="$1"
fi
filename=$(basename -- "$local_file_path")
base_name="${filename%.*}"
remote_mp4_name="processed.mp4"
remote_srt_name="processed.srt"

echo "üöÄ Starting videomessageify process for: $filename"

# Step 1: Upload the video file
echo "1/6: üì§ Uploading video to $server..."
rsync -Puv "$local_file_path" "$server:$remote_dir/"

# Steps 2 & 3: Re-encode (if needed) and Transcribe on the server
echo "2/6: üé¨ Re-encoding and transcribing on server (this may take a while)..."
transcription_success=true
ssh "$server" "
  set -e
  cd ~/$remote_dir
  mv \"$filename\" \"input_file\"
  echo 'Converting to MP4...'
  ffmpeg -i \"input_file\" -n \"$remote_mp4_name\"
  echo 'Activating Python venv...'
  source ~/waha-ai-timestamper-cli/venv/bin/activate
  echo 'Running Whisper transcription...'
  if ! whisper \"$remote_mp4_name\" --language en --output_format srt --word_timestamps True; then
    echo '‚ö†Ô∏è  Warning: Whisper transcription failed, continuing without transcription...'
    exit 1
  fi
" || transcription_success=false

# Check if transcription was successful
if [ "$transcription_success" = true ]; then
  # Step 4: Get SRT content and generate title with AI
  echo "3/6: ü§ñ Generating title with AI..."
  srt_content=$(ssh "$server" "cat ~/$remote_dir/\"$remote_srt_name\"")
  # MODIFIED PROMPT: Asks for a natural, capitalized title. 
  intro_prompt="Generate a concise, human-readable title for the following video transcript. The title should be in title case, like a normal document title. Do not include any illegal filename characters like slashes. Respond with ONLY the title itself. Transcript:\n\n"

  payload=$(tr -d '\r' <<< "$srt_content" | jq -Rs --arg model "$ai_model" --arg intro "$intro_prompt" '{ "model": $model, "messages": [{"role": "user", "content": ($intro + .)}], "max_tokens": 20 }')

  title_response=$(curl -s -H "Authorization: Bearer $OPENROUTER_API_KEY" \
                       -H "Content-Type: application/json" \
                       -d "$payload" \
                       https://openrouter.ai/api/v1/chat/completions)

  new_title=$(echo "$title_response" | jq -r '.choices[0].message.content')

  if [ -z "$new_title" ] || [ "$new_title" == "null" ]; then
      echo "‚ùå Error: AI failed to generate a title. Response: $title_response"
      exit 1
  fi
else
  # Generate a title based on the filename if transcription failed
  echo "3/6: ü§ñ Generating title based on filename (transcription failed)..."
  # Simple title generation from filename - replace underscores/hyphens with spaces and title case
  new_title=$(echo "$base_name" | sed 's/[_-]/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')
fi

# MODIFIED SANITIZATION: Removes only illegal characters, preserving case and spaces.
sanitized_title=$(echo "$new_title" | sed 's/[/\\?%*:|"<>]/ /g' | sed 's/  */ /g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
echo "‚ú® Generated title: $sanitized_title"

# Step 5: Rename the files on the server
echo "4/6: ‚úçÔ∏è Renaming files on the server..."
if [ "$transcription_success" = true ]; then
  ssh "$server" "
    cd ~/$remote_dir
    mv \"$remote_mp4_name\" \"$sanitized_title.mp4\"
    mv \"$remote_srt_name\" \"$sanitized_title.srt\"
  "
else
  ssh "$server" "
    cd ~/$remote_dir
    mv \"$remote_mp4_name\" \"$sanitized_title.mp4\"
    # No SRT file to rename if transcription failed
  "
fi

# Step 6: Create remote directory and move files with rclone FROM THE SERVER
echo "5/6: üöö Creating GDrive directory and copying files from server..."
if [ "$transcription_success" = true ]; then
  ssh "$server" "rclone copy -Puv ~/${remote_dir}/ \"${gdrive_remote}:${gdrive_dir}/${sanitized_title}/\" --include \"${sanitized_title}.mp4\" --include \"${sanitized_title}.srt\""
else
  ssh "$server" "rclone copy -Puv ~/${remote_dir}/ \"${gdrive_remote}:${gdrive_dir}/${sanitized_title}/\" --include \"${sanitized_title}.mp4\""
fi

# Step 7: Clean up processed files on the server
echo "6/6: üßπ Cleaning up processed files on server..."
if [ "$transcription_success" = true ]; then
  ssh "$server" "rm ~/$remote_dir/\"$sanitized_title.mp4\" ~/$remote_dir/\"input_file\" ~/$remote_dir/\"$sanitized_title.srt\""
else
  ssh "$server" "rm ~/$remote_dir/\"$sanitized_title.mp4\" ~/$remote_dir/\"input_file\""
fi

if [ "$transcription_success" = true ]; then
  echo "‚úÖ Success! Video Message '$sanitized_title' created with transcription."
else
  echo "‚úÖ Success! Video Message '$sanitized_title' created (transcription was skipped due to Whisper failure)."
fi